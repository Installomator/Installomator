name: Rebase from Upstream

# https://docs.github.com/en/actions/learn-github-actions/events-that-trigger-workflows#scheduled-events
on:
  schedule:              # run every monday at 5:03 AM UTC
    - cron: "3 5 * * 1"  # https://crontab.guru/#3_5_*_*_1

  workflow_dispatch:     # click the button on Github repo!

jobs:
  sync_latest_from_upstream:
    runs-on: ubuntu-latest
    steps:
    - name: "Checkout target repo"
      uses: actions/checkout@v2
      with:
        ref:  master
    - name: "[git] determine and set the BRANCH_NAME"
      run: |
        echo "BRANCH_NAME="automated-updates/`date "+%Y-%m-%d"` >> $GITHUB_ENV
    - name: "Sync upstream changes"
      id: sync
      uses: aormsby/Fork-Sync-With-Upstream-action@check-fix-2  # using branch
      with:
        target_sync_branch: master
        target_repo_token: ${{ secrets.GITHUB_TOKEN }}
        upstream_sync_branch: master
        upstream_sync_repo: Installomator/Installomator
        # test_mode: true
    - name: "Show value of 'has_new_commits'"
      run: |
        echo "Showing output from sync step"
        echo ${{ steps.sync.outputs.has_new_commits }}
        echo
        echo echo ${{ steps.sync.outputs }}
    - name: "[git] create a new branch"
      if: steps.sync.outputs.has_new_commits == 'true'
      uses: peterjgrainger/action-create-branch@v2.0.1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        branch: ${{ env.BRANCH_NAME }}
    - name: "create pull request"
      if: steps.sync.outputs.has_new_commits == 'true'
      uses: peter-evans/create-pull-request@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ env.BRANCH_NAME }}
        commit-message: "Bringing in latest changes from upstream."
        labels: |
          automated
    - name: "No new commits"
      if: steps.sync.outputs.has_new_commits == 'false'
      run: echo "There were no new commits."
