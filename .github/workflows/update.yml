name: Rebase from Upstream

# https://docs.github.com/en/actions/learn-github-actions/events-that-trigger-workflows#scheduled-events
on:
  schedule:              # run every monday at 5:03 AM UTC
    - cron: "3 5 * * 1"  # https://crontab.guru/#3_5_*_*_1

  workflow_dispatch:     # click the button on Github repo!

jobs:
  sync_latest_from_upstream:
    runs-on: ubuntu-latest
    steps:
    - name: "Checkout target repo"
      uses: actions/checkout@v2
      with:
        ref:  master
        persist-credentials: false
    - name: "[git] determine and set the BRANCH_NAME"
      run: |
        echo "BRANCH_NAME="automated-updates/`date "+%Y-%m-%d"` >> $GITHUB_ENV
    - name: "[git] checkout new branch"
      run: |
        echo "Creating a new branch:"${{ env.BRANCH_NAME }}
        git checkout -b ${{ env.BRANCH_NAME }}
    - name: "Sync upstream changes"
      id: sync
      uses: aormsby/Fork-Sync-With-Upstream-action@v3.1
      with:
        target_sync_branch: ${{ env.BRANCH_NAME }}
        target_repo_token: ${{ secrets.GITHUB_TOKEN }}
        upstream_sync_branch: master
        upstream_sync_repo: Installomator/Installomator
        upstream_repo_access_token: ${{ secrets.UPSTREAM_REPO_SECRET }}
    - name: "create pull request"
      uses: peter-evans/create-pull-request@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ env.BRANCH_NAME }}
        commit-message: "Bringing in latest changes from upstream."
        labels: |
          automated
    - name: "No new commits"
      if: steps.sync.outputs.has_new_commits == 'false'
      run: echo "There were no new commits."
    - name: "Show value of 'has_new_commits'"
      run: echo ${{ steps.sync.outputs.has_new_commits }}
